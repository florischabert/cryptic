/*
 * AES-256 CryDec Engine
 *
 * Copyright (C) 2012 Floris Chabert
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do
 * so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * TODO
 * - Key stretching (triple MD5)
 * - Block level SIMD
 *
 */

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <getopt.h>
#include <errno.h>

#define ROUNDS 14
#define XKEY_SIZE 240

const uint8_t sbox[256] = {
	0x63,0x7c,0x77,0x7b,0xf2,0x6b,0x6f,0xc5,0x30,0x01,0x67,0x2b,0xfe,0xd7,0xab,0x76,
	0xca,0x82,0xc9,0x7d,0xfa,0x59,0x47,0xf0,0xad,0xd4,0xa2,0xaf,0x9c,0xa4,0x72,0xc0,
	0xb7,0xfd,0x93,0x26,0x36,0x3f,0xf7,0xcc,0x34,0xa5,0xe5,0xf1,0x71,0xd8,0x31,0x15,
	0x04,0xc7,0x23,0xc3,0x18,0x96,0x05,0x9a,0x07,0x12,0x80,0xe2,0xeb,0x27,0xb2,0x75,
	0x09,0x83,0x2c,0x1a,0x1b,0x6e,0x5a,0xa0,0x52,0x3b,0xd6,0xb3,0x29,0xe3,0x2f,0x84,
	0x53,0xd1,0x00,0xed,0x20,0xfc,0xb1,0x5b,0x6a,0xcb,0xbe,0x39,0x4a,0x4c,0x58,0xcf,
	0xd0,0xef,0xaa,0xfb,0x43,0x4d,0x33,0x85,0x45,0xf9,0x02,0x7f,0x50,0x3c,0x9f,0xa8,
	0x51,0xa3,0x40,0x8f,0x92,0x9d,0x38,0xf5,0xbc,0xb6,0xda,0x21,0x10,0xff,0xf3,0xd2,
	0xcd,0x0c,0x13,0xec,0x5f,0x97,0x44,0x17,0xc4,0xa7,0x7e,0x3d,0x64,0x5d,0x19,0x73,
	0x60,0x81,0x4f,0xdc,0x22,0x2a,0x90,0x88,0x46,0xee,0xb8,0x14,0xde,0x5e,0x0b,0xdb,
	0xe0,0x32,0x3a,0x0a,0x49,0x06,0x24,0x5c,0xc2,0xd3,0xac,0x62,0x91,0x95,0xe4,0x79,
	0xe7,0xc8,0x37,0x6d,0x8d,0xd5,0x4e,0xa9,0x6c,0x56,0xf4,0xea,0x65,0x7a,0xae,0x08,
	0xba,0x78,0x25,0x2e,0x1c,0xa6,0xb4,0xc6,0xe8,0xdd,0x74,0x1f,0x4b,0xbd,0x8b,0x8a,
	0x70,0x3e,0xb5,0x66,0x48,0x03,0xf6,0x0e,0x61,0x35,0x57,0xb9,0x86,0xc1,0x1d,0x9e,
	0xe1,0xf8,0x98,0x11,0x69,0xd9,0x8e,0x94,0x9b,0x1e,0x87,0xe9,0xce,0x55,0x28,0xdf,
	0x8c,0xa1,0x89,0x0d,0xbf,0xe6,0x42,0x68,0x41,0x99,0x2d,0x0f,0xb0,0x54,0xbb,0x16
};

const uint8_t isbox[256] = {
	0x52,0x09,0x6a,0xd5,0x30,0x36,0xa5,0x38,0xbf,0x40,0xa3,0x9e,0x81,0xf3,0xd7,0xfb,
	0x7c,0xe3,0x39,0x82,0x9b,0x2f,0xff,0x87,0x34,0x8e,0x43,0x44,0xc4,0xde,0xe9,0xcb,
	0x54,0x7b,0x94,0x32,0xa6,0xc2,0x23,0x3d,0xee,0x4c,0x95,0x0b,0x42,0xfa,0xc3,0x4e,
	0x08,0x2e,0xa1,0x66,0x28,0xd9,0x24,0xb2,0x76,0x5b,0xa2,0x49,0x6d,0x8b,0xd1,0x25,
	0x72,0xf8,0xf6,0x64,0x86,0x68,0x98,0x16,0xd4,0xa4,0x5c,0xcc,0x5d,0x65,0xb6,0x92,
	0x6c,0x70,0x48,0x50,0xfd,0xed,0xb9,0xda,0x5e,0x15,0x46,0x57,0xa7,0x8d,0x9d,0x84,
	0x90,0xd8,0xab,0x00,0x8c,0xbc,0xd3,0x0a,0xf7,0xe4,0x58,0x05,0xb8,0xb3,0x45,0x06,
	0xd0,0x2c,0x1e,0x8f,0xca,0x3f,0x0f,0x02,0xc1,0xaf,0xbd,0x03,0x01,0x13,0x8a,0x6b,
	0x3a,0x91,0x11,0x41,0x4f,0x67,0xdc,0xea,0x97,0xf2,0xcf,0xce,0xf0,0xb4,0xe6,0x73,
	0x96,0xac,0x74,0x22,0xe7,0xad,0x35,0x85,0xe2,0xf9,0x37,0xe8,0x1c,0x75,0xdf,0x6e,
	0x47,0xf1,0x1a,0x71,0x1d,0x29,0xc5,0x89,0x6f,0xb7,0x62,0x0e,0xaa,0x18,0xbe,0x1b,
	0xfc,0x56,0x3e,0x4b,0xc6,0xd2,0x79,0x20,0x9a,0xdb,0xc0,0xfe,0x78,0xcd,0x5a,0xf4,
	0x1f,0xdd,0xa8,0x33,0x88,0x07,0xc7,0x31,0xb1,0x12,0x10,0x59,0x27,0x80,0xec,0x5f,
	0x60,0x51,0x7f,0xa9,0x19,0xb5,0x4a,0x0d,0x2d,0xe5,0x7a,0x9f,0x93,0xc9,0x9c,0xef,
	0xa0,0xe0,0x3b,0x4d,0xae,0x2a,0xf5,0xb0,0xc8,0xeb,0xbb,0x3c,0x83,0x53,0x99,0x61,
	0x17,0x2b,0x04,0x7e,0xba,0x77,0xd6,0x26,0xe1,0x69,0x14,0x63,0x55,0x21,0x0c,0x7d
};

const uint8_t rcon[256] = {
	0x8d,0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80,0x1b,0x36,0x6c,0xd8,0xab,0x4d,0x9a,
	0x2f,0x5e,0xbc,0x63,0xc6,0x97,0x35,0x6a,0xd4,0xb3,0x7d,0xfa,0xef,0xc5,0x91,0x39,
	0x72,0xe4,0xd3,0xbd,0x61,0xc2,0x9f,0x25,0x4a,0x94,0x33,0x66,0xcc,0x83,0x1d,0x3a,
	0x74,0xe8,0xcb,0x8d,0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80,0x1b,0x36,0x6c,0xd8,
	0xab,0x4d,0x9a,0x2f,0x5e,0xbc,0x63,0xc6,0x97,0x35,0x6a,0xd4,0xb3,0x7d,0xfa,0xef,
	0xc5,0x91,0x39,0x72,0xe4,0xd3,0xbd,0x61,0xc2,0x9f,0x25,0x4a,0x94,0x33,0x66,0xcc,
	0x83,0x1d,0x3a,0x74,0xe8,0xcb,0x8d,0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80,0x1b,
	0x36,0x6c,0xd8,0xab,0x4d,0x9a,0x2f,0x5e,0xbc,0x63,0xc6,0x97,0x35,0x6a,0xd4,0xb3,
	0x7d,0xfa,0xef,0xc5,0x91,0x39,0x72,0xe4,0xd3,0xbd,0x61,0xc2,0x9f,0x25,0x4a,0x94,
	0x33,0x66,0xcc,0x83,0x1d,0x3a,0x74,0xe8,0xcb,0x8d,0x01,0x02,0x04,0x08,0x10,0x20,
	0x40,0x80,0x1b,0x36,0x6c,0xd8,0xab,0x4d,0x9a,0x2f,0x5e,0xbc,0x63,0xc6,0x97,0x35,
	0x6a,0xd4,0xb3,0x7d,0xfa,0xef,0xc5,0x91,0x39,0x72,0xe4,0xd3,0xbd,0x61,0xc2,0x9f,
	0x25,0x4a,0x94,0x33,0x66,0xcc,0x83,0x1d,0x3a,0x74,0xe8,0xcb,0x8d,0x01,0x02,0x04,
	0x08,0x10,0x20,0x40,0x80,0x1b,0x36,0x6c,0xd8,0xab,0x4d,0x9a,0x2f,0x5e,0xbc,0x63,
	0xc6,0x97,0x35,0x6a,0xd4,0xb3,0x7d,0xfa,0xef,0xc5,0x91,0x39,0x72,0xe4,0xd3,0xbd,
	0x61,0xc2,0x9f,0x25,0x4a,0x94,0x33,0x66,0xcc,0x83,0x1d,0x3a,0x74,0xe8,0xcb
};

const uint8_t galoisx02[256] = {
	0x00,0x02,0x04,0x06,0x08,0x0a,0x0c,0x0e,0x10,0x12,0x14,0x16,0x18,0x1a,0x1c,0x1e,
	0x20,0x22,0x24,0x26,0x28,0x2a,0x2c,0x2e,0x30,0x32,0x34,0x36,0x38,0x3a,0x3c,0x3e,
	0x40,0x42,0x44,0x46,0x48,0x4a,0x4c,0x4e,0x50,0x52,0x54,0x56,0x58,0x5a,0x5c,0x5e,
	0x60,0x62,0x64,0x66,0x68,0x6a,0x6c,0x6e,0x70,0x72,0x74,0x76,0x78,0x7a,0x7c,0x7e,
	0x80,0x82,0x84,0x86,0x88,0x8a,0x8c,0x8e,0x90,0x92,0x94,0x96,0x98,0x9a,0x9c,0x9e,
	0xa0,0xa2,0xa4,0xa6,0xa8,0xaa,0xac,0xae,0xb0,0xb2,0xb4,0xb6,0xb8,0xba,0xbc,0xbe,
	0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,0xde,
	0xe0,0xe2,0xe4,0xe6,0xe8,0xea,0xec,0xee,0xf0,0xf2,0xf4,0xf6,0xf8,0xfa,0xfc,0xfe,
	0x1b,0x19,0x1f,0x1d,0x13,0x11,0x17,0x15,0x0b,0x09,0x0f,0x0d,0x03,0x01,0x07,0x05,
	0x3b,0x39,0x3f,0x3d,0x33,0x31,0x37,0x35,0x2b,0x29,0x2f,0x2d,0x23,0x21,0x27,0x25,
	0x5b,0x59,0x5f,0x5d,0x53,0x51,0x57,0x55,0x4b,0x49,0x4f,0x4d,0x43,0x41,0x47,0x45,
	0x7b,0x79,0x7f,0x7d,0x73,0x71,0x77,0x75,0x6b,0x69,0x6f,0x6d,0x63,0x61,0x67,0x65,
	0x9b,0x99,0x9f,0x9d,0x93,0x91,0x97,0x95,0x8b,0x89,0x8f,0x8d,0x83,0x81,0x87,0x85,
	0xbb,0xb9,0xbf,0xbd,0xb3,0xb1,0xb7,0xb5,0xab,0xa9,0xaf,0xad,0xa3,0xa1,0xa7,0xa5,
	0xdb,0xd9,0xdf,0xdd,0xd3,0xd1,0xd7,0xd5,0xcb,0xc9,0xcf,0xcd,0xc3,0xc1,0xc7,0xc5,
	0xfb,0xf9,0xff,0xfd,0xf3,0xf1,0xf7,0xf5,0xeb,0xe9,0xef,0xed,0xe3,0xe1,0xe7,0xe5
};

const uint8_t galoisx03[256] = {
	0x00,0x03,0x06,0x05,0x0c,0x0f,0x0a,0x09,0x18,0x1b,0x1e,0x1d,0x14,0x17,0x12,0x11,
	0x30,0x33,0x36,0x35,0x3c,0x3f,0x3a,0x39,0x28,0x2b,0x2e,0x2d,0x24,0x27,0x22,0x21,
	0x60,0x63,0x66,0x65,0x6c,0x6f,0x6a,0x69,0x78,0x7b,0x7e,0x7d,0x74,0x77,0x72,0x71,
	0x50,0x53,0x56,0x55,0x5c,0x5f,0x5a,0x59,0x48,0x4b,0x4e,0x4d,0x44,0x47,0x42,0x41,
	0xc0,0xc3,0xc6,0xc5,0xcc,0xcf,0xca,0xc9,0xd8,0xdb,0xde,0xdd,0xd4,0xd7,0xd2,0xd1,
	0xf0,0xf3,0xf6,0xf5,0xfc,0xff,0xfa,0xf9,0xe8,0xeb,0xee,0xed,0xe4,0xe7,0xe2,0xe1,
	0xa0,0xa3,0xa6,0xa5,0xac,0xaf,0xaa,0xa9,0xb8,0xbb,0xbe,0xbd,0xb4,0xb7,0xb2,0xb1,
	0x90,0x93,0x96,0x95,0x9c,0x9f,0x9a,0x99,0x88,0x8b,0x8e,0x8d,0x84,0x87,0x82,0x81,
	0x9b,0x98,0x9d,0x9e,0x97,0x94,0x91,0x92,0x83,0x80,0x85,0x86,0x8f,0x8c,0x89,0x8a,
	0xab,0xa8,0xad,0xae,0xa7,0xa4,0xa1,0xa2,0xb3,0xb0,0xb5,0xb6,0xbf,0xbc,0xb9,0xba,
	0xfb,0xf8,0xfd,0xfe,0xf7,0xf4,0xf1,0xf2,0xe3,0xe0,0xe5,0xe6,0xef,0xec,0xe9,0xea,
	0xcb,0xc8,0xcd,0xce,0xc7,0xc4,0xc1,0xc2,0xd3,0xd0,0xd5,0xd6,0xdf,0xdc,0xd9,0xda,
	0x5b,0x58,0x5d,0x5e,0x57,0x54,0x51,0x52,0x43,0x40,0x45,0x46,0x4f,0x4c,0x49,0x4a,
	0x6b,0x68,0x6d,0x6e,0x67,0x64,0x61,0x62,0x73,0x70,0x75,0x76,0x7f,0x7c,0x79,0x7a,
	0x3b,0x38,0x3d,0x3e,0x37,0x34,0x31,0x32,0x23,0x20,0x25,0x26,0x2f,0x2c,0x29,0x2a,
	0x0b,0x08,0x0d,0x0e,0x07,0x04,0x01,0x02,0x13,0x10,0x15,0x16,0x1f,0x1c,0x19,0x1a
};

const uint8_t galoisx09[256] = {
	0x00,0x09,0x12,0x1b,0x24,0x2d,0x36,0x3f,0x48,0x41,0x5a,0x53,0x6c,0x65,0x7e,0x77,
	0x90,0x99,0x82,0x8b,0xb4,0xbd,0xa6,0xaf,0xd8,0xd1,0xca,0xc3,0xfc,0xf5,0xee,0xe7,
	0x3b,0x32,0x29,0x20,0x1f,0x16,0x0d,0x04,0x73,0x7a,0x61,0x68,0x57,0x5e,0x45,0x4c,
	0xab,0xa2,0xb9,0xb0,0x8f,0x86,0x9d,0x94,0xe3,0xea,0xf1,0xf8,0xc7,0xce,0xd5,0xdc,
	0x76,0x7f,0x64,0x6d,0x52,0x5b,0x40,0x49,0x3e,0x37,0x2c,0x25,0x1a,0x13,0x08,0x01,
	0xe6,0xef,0xf4,0xfd,0xc2,0xcb,0xd0,0xd9,0xae,0xa7,0xbc,0xb5,0x8a,0x83,0x98,0x91,
	0x4d,0x44,0x5f,0x56,0x69,0x60,0x7b,0x72,0x05,0x0c,0x17,0x1e,0x21,0x28,0x33,0x3a,
	0xdd,0xd4,0xcf,0xc6,0xf9,0xf0,0xeb,0xe2,0x95,0x9c,0x87,0x8e,0xb1,0xb8,0xa3,0xaa,
	0xec,0xe5,0xfe,0xf7,0xc8,0xc1,0xda,0xd3,0xa4,0xad,0xb6,0xbf,0x80,0x89,0x92,0x9b,
	0x7c,0x75,0x6e,0x67,0x58,0x51,0x4a,0x43,0x34,0x3d,0x26,0x2f,0x10,0x19,0x02,0x0b,
	0xd7,0xde,0xc5,0xcc,0xf3,0xfa,0xe1,0xe8,0x9f,0x96,0x8d,0x84,0xbb,0xb2,0xa9,0xa0,
	0x47,0x4e,0x55,0x5c,0x63,0x6a,0x71,0x78,0x0f,0x06,0x1d,0x14,0x2b,0x22,0x39,0x30,
	0x9a,0x93,0x88,0x81,0xbe,0xb7,0xac,0xa5,0xd2,0xdb,0xc0,0xc9,0xf6,0xff,0xe4,0xed,
	0x0a,0x03,0x18,0x11,0x2e,0x27,0x3c,0x35,0x42,0x4b,0x50,0x59,0x66,0x6f,0x74,0x7d,
	0xa1,0xa8,0xb3,0xba,0x85,0x8c,0x97,0x9e,0xe9,0xe0,0xfb,0xf2,0xcd,0xc4,0xdf,0xd6,
	0x31,0x38,0x23,0x2a,0x15,0x1c,0x07,0x0e,0x79,0x70,0x6b,0x62,0x5d,0x54,0x4f,0x46
};

const uint8_t galoisx11[256] = {
	0x00,0x0b,0x16,0x1d,0x2c,0x27,0x3a,0x31,0x58,0x53,0x4e,0x45,0x74,0x7f,0x62,0x69,
	0xb0,0xbb,0xa6,0xad,0x9c,0x97,0x8a,0x81,0xe8,0xe3,0xfe,0xf5,0xc4,0xcf,0xd2,0xd9,
	0x7b,0x70,0x6d,0x66,0x57,0x5c,0x41,0x4a,0x23,0x28,0x35,0x3e,0x0f,0x04,0x19,0x12,
	0xcb,0xc0,0xdd,0xd6,0xe7,0xec,0xf1,0xfa,0x93,0x98,0x85,0x8e,0xbf,0xb4,0xa9,0xa2,
	0xf6,0xfd,0xe0,0xeb,0xda,0xd1,0xcc,0xc7,0xae,0xa5,0xb8,0xb3,0x82,0x89,0x94,0x9f,
	0x46,0x4d,0x50,0x5b,0x6a,0x61,0x7c,0x77,0x1e,0x15,0x08,0x03,0x32,0x39,0x24,0x2f,
	0x8d,0x86,0x9b,0x90,0xa1,0xaa,0xb7,0xbc,0xd5,0xde,0xc3,0xc8,0xf9,0xf2,0xef,0xe4,
	0x3d,0x36,0x2b,0x20,0x11,0x1a,0x07,0x0c,0x65,0x6e,0x73,0x78,0x49,0x42,0x5f,0x54,
	0xf7,0xfc,0xe1,0xea,0xdb,0xd0,0xcd,0xc6,0xaf,0xa4,0xb9,0xb2,0x83,0x88,0x95,0x9e,
	0x47,0x4c,0x51,0x5a,0x6b,0x60,0x7d,0x76,0x1f,0x14,0x09,0x02,0x33,0x38,0x25,0x2e,
	0x8c,0x87,0x9a,0x91,0xa0,0xab,0xb6,0xbd,0xd4,0xdf,0xc2,0xc9,0xf8,0xf3,0xee,0xe5,
	0x3c,0x37,0x2a,0x21,0x10,0x1b,0x06,0x0d,0x64,0x6f,0x72,0x79,0x48,0x43,0x5e,0x55,
	0x01,0x0a,0x17,0x1c,0x2d,0x26,0x3b,0x30,0x59,0x52,0x4f,0x44,0x75,0x7e,0x63,0x68,
	0xb1,0xba,0xa7,0xac,0x9d,0x96,0x8b,0x80,0xe9,0xe2,0xff,0xf4,0xc5,0xce,0xd3,0xd8,
	0x7a,0x71,0x6c,0x67,0x56,0x5d,0x40,0x4b,0x22,0x29,0x34,0x3f,0x0e,0x05,0x18,0x13,
	0xca,0xc1,0xdc,0xd7,0xe6,0xed,0xf0,0xfb,0x92,0x99,0x84,0x8f,0xbe,0xb5,0xa8,0xa3
};

const uint8_t galoisx13[256] = {
	0x00,0x0d,0x1a,0x17,0x34,0x39,0x2e,0x23,0x68,0x65,0x72,0x7f,0x5c,0x51,0x46,0x4b,
	0xd0,0xdd,0xca,0xc7,0xe4,0xe9,0xfe,0xf3,0xb8,0xb5,0xa2,0xaf,0x8c,0x81,0x96,0x9b,
	0xbb,0xb6,0xa1,0xac,0x8f,0x82,0x95,0x98,0xd3,0xde,0xc9,0xc4,0xe7,0xea,0xfd,0xf0,
	0x6b,0x66,0x71,0x7c,0x5f,0x52,0x45,0x48,0x03,0x0e,0x19,0x14,0x37,0x3a,0x2d,0x20,
	0x6d,0x60,0x77,0x7a,0x59,0x54,0x43,0x4e,0x05,0x08,0x1f,0x12,0x31,0x3c,0x2b,0x26,
	0xbd,0xb0,0xa7,0xaa,0x89,0x84,0x93,0x9e,0xd5,0xd8,0xcf,0xc2,0xe1,0xec,0xfb,0xf6,
	0xd6,0xdb,0xcc,0xc1,0xe2,0xef,0xf8,0xf5,0xbe,0xb3,0xa4,0xa9,0x8a,0x87,0x90,0x9d,
	0x06,0x0b,0x1c,0x11,0x32,0x3f,0x28,0x25,0x6e,0x63,0x74,0x79,0x5a,0x57,0x40,0x4d,
	0xda,0xd7,0xc0,0xcd,0xee,0xe3,0xf4,0xf9,0xb2,0xbf,0xa8,0xa5,0x86,0x8b,0x9c,0x91,
	0x0a,0x07,0x10,0x1d,0x3e,0x33,0x24,0x29,0x62,0x6f,0x78,0x75,0x56,0x5b,0x4c,0x41,
	0x61,0x6c,0x7b,0x76,0x55,0x58,0x4f,0x42,0x09,0x04,0x13,0x1e,0x3d,0x30,0x27,0x2a,
	0xb1,0xbc,0xab,0xa6,0x85,0x88,0x9f,0x92,0xd9,0xd4,0xc3,0xce,0xed,0xe0,0xf7,0xfa,
	0xb7,0xba,0xad,0xa0,0x83,0x8e,0x99,0x94,0xdf,0xd2,0xc5,0xc8,0xeb,0xe6,0xf1,0xfc,
	0x67,0x6a,0x7d,0x70,0x53,0x5e,0x49,0x44,0x0f,0x02,0x15,0x18,0x3b,0x36,0x21,0x2c,
	0x0c,0x01,0x16,0x1b,0x38,0x35,0x22,0x2f,0x64,0x69,0x7e,0x73,0x50,0x5d,0x4a,0x47,
	0xdc,0xd1,0xc6,0xcb,0xe8,0xe5,0xf2,0xff,0xb4,0xb9,0xae,0xa3,0x80,0x8d,0x9a,0x97
};

const uint8_t galoisx14[256] = {
	0x00,0x0e,0x1c,0x12,0x38,0x36,0x24,0x2a,0x70,0x7e,0x6c,0x62,0x48,0x46,0x54,0x5a,
	0xe0,0xee,0xfc,0xf2,0xd8,0xd6,0xc4,0xca,0x90,0x9e,0x8c,0x82,0xa8,0xa6,0xb4,0xba,
	0xdb,0xd5,0xc7,0xc9,0xe3,0xed,0xff,0xf1,0xab,0xa5,0xb7,0xb9,0x93,0x9d,0x8f,0x81,
	0x3b,0x35,0x27,0x29,0x03,0x0d,0x1f,0x11,0x4b,0x45,0x57,0x59,0x73,0x7d,0x6f,0x61,
	0xad,0xa3,0xb1,0xbf,0x95,0x9b,0x89,0x87,0xdd,0xd3,0xc1,0xcf,0xe5,0xeb,0xf9,0xf7,
	0x4d,0x43,0x51,0x5f,0x75,0x7b,0x69,0x67,0x3d,0x33,0x21,0x2f,0x05,0x0b,0x19,0x17,
	0x76,0x78,0x6a,0x64,0x4e,0x40,0x52,0x5c,0x06,0x08,0x1a,0x14,0x3e,0x30,0x22,0x2c,
	0x96,0x98,0x8a,0x84,0xae,0xa0,0xb2,0xbc,0xe6,0xe8,0xfa,0xf4,0xde,0xd0,0xc2,0xcc,
	0x41,0x4f,0x5d,0x53,0x79,0x77,0x65,0x6b,0x31,0x3f,0x2d,0x23,0x09,0x07,0x15,0x1b,
	0xa1,0xaf,0xbd,0xb3,0x99,0x97,0x85,0x8b,0xd1,0xdf,0xcd,0xc3,0xe9,0xe7,0xf5,0xfb,
	0x9a,0x94,0x86,0x88,0xa2,0xac,0xbe,0xb0,0xea,0xe4,0xf6,0xf8,0xd2,0xdc,0xce,0xc0,
	0x7a,0x74,0x66,0x68,0x42,0x4c,0x5e,0x50,0x0a,0x04,0x16,0x18,0x32,0x3c,0x2e,0x20,
	0xec,0xe2,0xf0,0xfe,0xd4,0xda,0xc8,0xc6,0x9c,0x92,0x80,0x8e,0xa4,0xaa,0xb8,0xb6,
	0x0c,0x02,0x10,0x1e,0x34,0x3a,0x28,0x26,0x7c,0x72,0x60,0x6e,0x44,0x4a,0x58,0x56,
	0x37,0x39,0x2b,0x25,0x0f,0x01,0x13,0x1d,0x47,0x49,0x5b,0x55,0x7f,0x71,0x63,0x6d,
	0xd7,0xd9,0xcb,0xc5,0xef,0xe1,0xf3,0xfd,0xa7,0xa9,0xbb,0xb5,0x9f,0x91,0x83,0x8d
};

static int leftrotate(int x, int c)
{
	return (x << c) | (x >> (32 - c));
}

static void md5(uint8_t hash[16], uint8_t *data, int size)
{
	static const uint32_t r[64] = {
		7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22, 
		5,  9, 14, 20, 5,  9, 14, 20, 5,  9, 14, 20, 5,  9, 14, 20,
		4, 11, 16, 23, 4, 11, 16, 23, 4, 11, 16, 23, 4, 11, 16, 23,
		6, 10, 15, 21, 6, 10, 15, 21, 6, 10, 15, 21, 6, 10, 15, 21
	};
	static const uint32_t k[64] = {
		0xd76aa478, 0xe8c7b756, 0x242070db, 0xc1bdceee,
		0xf57c0faf, 0x4787c62a, 0xa8304613, 0xfd469501,
		0x698098d8, 0x8b44f7af, 0xffff5bb1, 0x895cd7be,
		0x6b901122, 0xfd987193, 0xa679438e, 0x49b40821,
		0xf61e2562, 0xc040b340, 0x265e5a51, 0xe9b6c7aa,
		0xd62f105d, 0x02441453, 0xd8a1e681, 0xe7d3fbc8,
		0x21e1cde6, 0xc33707d6, 0xf4d50d87, 0x455a14ed,
		0xa9e3e905, 0xfcefa3f8, 0x676f02d9, 0x8d2a4c8a,
		0xfffa3942, 0x8771f681, 0x6d9d6122, 0xfde5380c,
		0xa4beea44, 0x4bdecfa9, 0xf6bb4b60, 0xbebfbc70,
		0x289b7ec6, 0xeaa127fa, 0xd4ef3085, 0x04881d05,
		0xd9d4d039, 0xe6db99e5, 0x1fa27cf8, 0xc4ac5665,
		0xf4292244, 0x432aff97, 0xab9423a7, 0xfc93a039,
		0x655b59c3, 0x8f0ccc92, 0xffeff47d, 0x85845dd1,
		0x6fa87e4f, 0xfe2ce6e0, 0xa3014314, 0x4e0811a1,
		0xf7537e82, 0xbd3af235, 0x2ad7d2bb, 0xeb86d391
	};
	uint32_t h[4] = {
		0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476
	};
	int i;
	int nb_blocks = size/64;
	uint32_t last_block[16];

	if (nb_blocks*64 == size) {
		nb_blocks++;
	}

	i = 64*(nb_blocks-1);
	bzero(last_block, sizeof(last_block));
	memcpy(last_block, data + i, size-i);
	*((uint8_t *)last_block + size-i) = 0x80;
	*((uint64_t *)last_block + 7) = size;

	for (i = 0; i < nb_blocks; i++) {
		uint32_t *w = (char *)data + 64*i;

		if (i == nb_blocks - 1) {
			w = last_block;
		}
		
		for (j = 0; j < 16; j++) {
			int a = h[0];
			int b = h[1];
			int c = h[2];
			int d = h[3];
			int tmp;

			for (l = 0; l < 64; l++) {
				if (0 <= l && l < 16) {
					f = (b & c) | (~b & d);
					g = l;
				}
				else if (16 <= l && l < 32) {
					f = (d & b) | (~d & c);
					g = (5*l + 1) % 16;
				}
				else if (32 <= l && i < 48) {
					f = b ^ c ^ d;
					g = (3*l + 5) % 16;
				}
				else if (48 <= l && l < 64) {
					f = c ^ (b | ~d);
					g = (7*l) % 16;
				}
			}

			tmp = d;
			d = c;
			c = b;
			b = b + leftrotate((a + f + k[l] + w[g]) , r[l]);
			a = tmp;
		}

		h[0] = h[0] + a;
		h[1] = h[1] + b;
		h[2] = h[2] + c;
		h[3] = h[3] + d;
	}
	
	memcpy(hash, h, 16);
}

void stretchkey(const char *passwd, uint8_t key[32], uint8_t iv[16])
{
	uint8_t hash[3][16];
	uint8_t data[32+16+16];
	uint8_t salt[16] = { 0 };
	size_t len = strlen(passwd);
	if (len > 32) len = 32;

	memcpy(data, passwd, len); 
	memcpy(data+len, salt, 16); 
	md5(hash[0], data, len+16); 

	memcpy(data, hash[0], 16); 
	memcpy(data+16, passwd, len); 
	memcpy(data+16+len, salt, 16); 
	md5(hash[1], data, 16+len+16); 

	memcpy(data, hash[1], 16); 
	memcpy(data+16, passwd, len); 
	memcpy(data+16+len, salt, 16); 
	md5(hash[2], data, 16+len+16); 

	memcpy(key, hash[0], 16);
	memcpy(key+16, hash[1], 16);
	memcpy(iv, hash[2], 16);



	memset(key, 0, 32);
	memset(iv, 0, 16);
}

void expandkey(const uint8_t key[32], uint8_t *xkey)
{
	int i = 1;
	int size = 0;
	uint8_t tmp[4];

	memcpy(xkey, key, 32);
	size += 32;

	while (size < XKEY_SIZE) {
		memcpy(tmp, &xkey[size-4], 4);

		if ((size & 0x1f) == 0) {
			uint8_t first = tmp[0];
			tmp[0] = sbox[tmp[1]] ^ rcon[i];
			tmp[1] = sbox[tmp[2]];
			tmp[2] = sbox[tmp[3]];
			tmp[3] = sbox[first];
			i++;
		}

		if ((size & 0x1f) == 0x10) {
			tmp[0] = sbox[tmp[0]];
			tmp[1] = sbox[tmp[1]];
			tmp[2] = sbox[tmp[2]];
			tmp[3] = sbox[tmp[3]];
		}

		xkey[size+0] = tmp[0] ^ xkey[size-32+0];
		xkey[size+1] = tmp[1] ^ xkey[size-32+1];
		xkey[size+2] = tmp[2] ^ xkey[size-32+2];
		xkey[size+3] = tmp[3] ^ xkey[size-32+3];
		size += 4;
	}
}

static void addroundkey(uint8_t block[16], const uint8_t *xkey, int round)
{
	const uint8_t *roundkey = &xkey[round << 4];
	int i;
	for (i = 0; i < 16; i +=4) {
		block[i+0] ^= roundkey[i+0];
		block[i+1] ^= roundkey[i+1];
		block[i+2] ^= roundkey[i+2];
		block[i+3] ^= roundkey[i+3];
	}
}

static inline void lookup(uint8_t block[16], const uint8_t *pos)
{
	int i;
	for (i = 0; i < 16; i += 4) {
		block[i+0] = pos[block[i+0]];
		block[i+1] = pos[block[i+1]];
		block[i+2] = pos[block[i+2]];
		block[i+3] = pos[block[i+3]];
	}
}

static void subbytes(uint8_t block[16])
{
	lookup(block, sbox);
}

static void isubbytes(uint8_t block[16])
{
	lookup(block, isbox);
}

static void shiftrows(uint8_t block[16])
{
	uint32_t *block32 = (uint32_t *)block;
	uint32_t tmp[4] = {
		block[ 0] | block[ 5] << 8 | block[10] << 16 | block[15] << 24,
		block[ 4] | block[ 9] << 8 | block[14] << 16 | block[ 3] << 24, 
		block[ 8] | block[13] << 8 | block[ 2] << 16 | block[ 7] << 24,
		block[12] | block[ 1] << 8 | block[ 6] << 16 | block[11] << 24
	};
	block32[0] = tmp[0];
	block32[1] = tmp[1];
	block32[2] = tmp[2];
	block32[3] = tmp[3];
}

static void ishiftrows(uint8_t block[16])
{
	uint32_t *block32 = (uint32_t *)block;
	uint32_t tmp[4] = {
		block[ 0] | block[13] << 8 | block[10] << 16 | block[ 7] << 24,
		block[ 4] | block[ 1] << 8 | block[14] << 16 | block[11] << 24, 
		block[ 8] | block[ 5] << 8 | block[ 2] << 16 | block[15] << 24,
		block[12] | block[ 9] << 8 | block[ 6] << 16 | block[ 3] << 24
	};
	block32[0] = tmp[0];
	block32[1] = tmp[1];
	block32[2] = tmp[2];
	block32[3] = tmp[3];
}

static void mixcolumns(uint8_t block[16])
{
	int col;
	uint32_t *block32 = (uint32_t *)block;
	for (col = 0; col < 4; col++) {
		uint32_t ncol;
		ncol  = galoisx02[block[col*4+0]]
		      | block[col*4+0] << 8
		      | block[col*4+0] << 16
		      | galoisx03[block[col*4+0]] << 24;
		ncol ^= galoisx03[block[col*4+1]]
		      | galoisx02[block[col*4+1]] << 8
		      | block[col*4+1] << 16
		      | block[col*4+1] << 24;
		ncol ^= block[col*4+2]
		      | galoisx03[block[col*4+2]] << 8
		      | galoisx02[block[col*4+2]] << 16
		      | block[col*4+2] << 24;
        ncol ^= block[col*4+3]
		      | block[col*4+3] << 8
		      | galoisx03[block[col*4+3]] << 16
		      | galoisx02[block[col*4+3]] << 24;
		*(block32+col) = ncol;
	}
}

static void imixcolumns(uint8_t block[16])
{
	int col;
	uint32_t *block32 = (uint32_t *)block;
	for (col = 0; col < 4; col++) {
		uint32_t ncol;
		ncol  = galoisx14[block[col*4+0]]
		      | galoisx09[block[col*4+0]] << 8
		      | galoisx13[block[col*4+0]] << 16
		      | galoisx11[block[col*4+0]] << 24;
		ncol ^= galoisx11[block[col*4+1]]
		      | galoisx14[block[col*4+1]] << 8
		      | galoisx09[block[col*4+1]] << 16
		      | galoisx13[block[col*4+1]] << 24;
		ncol ^= galoisx13[block[col*4+2]]
		      | galoisx11[block[col*4+2]] << 8
		      | galoisx14[block[col*4+2]] << 16
		      | galoisx09[block[col*4+2]] << 24;
        ncol ^= galoisx09[block[col*4+3]]
		      | galoisx13[block[col*4+3]] << 8
		      | galoisx11[block[col*4+3]] << 16
		      | galoisx14[block[col*4+3]] << 24;
		*(block32+col) = ncol;
	}
}

void encrypt_block(const uint8_t *xkey, uint8_t block[16])
{
	int round;

	addroundkey(block, xkey, 0);

	for (round = 1; round < ROUNDS; round++) {
		subbytes(block);
		shiftrows(block);
		mixcolumns(block);
		addroundkey(block, xkey, round);
	}

	subbytes(block);
	shiftrows(block);
	addroundkey(block, xkey, round);
}

void decrypt_block(const uint8_t *xkey, uint8_t block[16])
{
	int round;

	addroundkey(block, xkey, ROUNDS);
	ishiftrows(block);
	isubbytes(block);

	for (round = ROUNDS-1; round > 0; round--) {
		addroundkey(block, xkey, round);
		imixcolumns(block);
		ishiftrows(block);
		isubbytes(block);
	}

	addroundkey(block, xkey, round);
}

static inline void xor(uint8_t * __restrict block, const uint8_t * __restrict iv)
{
	int i;
	for (i = 0; i < 16; i +=4) {
		block[i+0] ^= iv[i+0];
		block[i+1] ^= iv[i+1];
		block[i+2] ^= iv[i+2];
		block[i+3] ^= iv[i+3];
	}
}

int encrypt_stream(const uint8_t *xkey, const uint8_t iv[16], FILE *in, FILE *out)
{
	static uint8_t block[16];
	static uint8_t prev[16];
	size_t written;
	size_t size;

	memcpy(prev, iv, 16);

	while ((size = fread(block, 1, 16, in)) == 16) {
		xor(block, prev);
		encrypt_block(xkey, block);
		memcpy(prev, block, 16);

		written = fwrite(block, 1, 16, out);
		if (written != 16) return -1;
	}

	memset(block+size, 16-size, 16-size);

	xor(block, prev);
	encrypt_block(xkey, block);
	
	written = fwrite(block, 1, 16, out);
	if (written != 16) return -1;

	return 0;
}

int decrypt_stream(const uint8_t *xkey, const uint8_t iv[16], FILE *in, FILE *out)
{
	static uint8_t block[16];
	static uint8_t pprev[16];
	static uint8_t cprev[16];
	static uint8_t tmp[16];
	size_t written;
	size_t size;
	int first = 1;

	while ((size = fread(block, 1, 16, in)) == 16) {
		if (!first) {
			written = fwrite(cprev, 1, 16, out);
			if (written != 16) return -1;
		}
		memcpy(tmp, block, 16);
		decrypt_block(xkey, block);
		if (first) {
			xor(block, iv);
			first = 0;
		} else {
			xor(block, pprev);
		}
		memcpy(pprev, tmp, 16);
		memcpy(cprev, block, 16);
	}

	if (size != 0) return -1;

	size = 16-block[15];
	if (size > 16) return -1;

	written = fwrite(block, 1, size, out);
	if (written != size) return -1;

	return 0;
}

void selftest(void)
{
 	static const uint8_t *xkeyinit =
		"\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f"\
		"\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f"\
		"\xa5\x73\xc2\x9f\xa1\x76\xc4\x98\xa9\x7f\xce\x93\xa5\x72\xc0\x9c"\
		"\x16\x51\xa8\xcd\x02\x44\xbe\xda\x1a\x5d\xa4\xc1\x06\x40\xba\xde"\
		"\xae\x87\xdf\xf0\x0f\xf1\x1b\x68\xa6\x8e\xd5\xfb\x03\xfc\x15\x67"\
		"\x6d\xe1\xf1\x48\x6f\xa5\x4f\x92\x75\xf8\xeb\x53\x73\xb8\x51\x8d"\
		"\xc6\x56\x82\x7f\xc9\xa7\x99\x17\x6f\x29\x4c\xec\x6c\xd5\x59\x8b"\
		"\x3d\xe2\x3a\x75\x52\x47\x75\xe7\x27\xbf\x9e\xb4\x54\x07\xcf\x39"\
		"\x0b\xdc\x90\x5f\xc2\x7b\x09\x48\xad\x52\x45\xa4\xc1\x87\x1c\x2f"\
		"\x45\xf5\xa6\x60\x17\xb2\xd3\x87\x30\x0d\x4d\x33\x64\x0a\x82\x0a"\
		"\x7c\xcf\xf7\x1c\xbe\xb4\xfe\x54\x13\xe6\xbb\xf0\xd2\x61\xa7\xdf"\
		"\xf0\x1a\xfa\xfe\xe7\xa8\x29\x79\xd7\xa5\x64\x4a\xb3\xaf\xe6\x40"\
		"\x25\x41\xfe\x71\x9b\xf5\x00\x25\x88\x13\xbb\xd5\x5a\x72\x1c\x0a"\
		"\x4e\x5a\x66\x99\xa9\xf2\x4f\xe0\x7e\x57\x2b\xaa\xcd\xf8\xcd\xea"\
		"\x24\xfc\x79\xcc\xbf\x09\x79\xe9\x37\x1a\xc2\x3c\x6d\x68\xde\x36";
	static const uint8_t *text = 
		"\x00\x11\x22\x33\x44\x55\x66\x77\x88\x99\xaa\xbb\xcc\xdd\xee\xff";
	static const uint8_t *ark0 =
		"\x00\x10\x20\x30\x40\x50\x60\x70\x80\x90\xa0\xb0\xc0\xd0\xe0\xf0";
	static const uint8_t *sub1 = 
		"\x63\xca\xb7\x04\x09\x53\xd0\x51\xcd\x60\xe0\xe7\xba\x70\xe1\x8c";
	static const uint8_t *shr1 = 
		"\x63\x53\xe0\x8c\x09\x60\xe1\x04\xcd\x70\xb7\x51\xba\xca\xd0\xe7";
	static const uint8_t *mix1 = 
		"\x5f\x72\x64\x15\x57\xf5\xbc\x92\xf7\xbe\x3b\x29\x1d\xb9\xf9\x1a";
	static const uint8_t *cryp = 
		"\x8e\xa2\xb7\xca\x51\x67\x45\xbf\xea\xfc\x49\x90\x4b\x49\x60\x89";
	static const uint8_t *ista = 
		"\x2c\x21\xa8\x20\x30\x6f\x15\x4a\xb7\x12\xc7\x5e\xee\x0d\xa0\x4f";
	static const uint8_t *imi1 = 
		"\xd1\xed\x44\xfd\x1a\x0f\x3f\x2a\xfa\x4f\xf2\x7b\x7c\x33\x2a\x69";
	static const uint8_t *ish1 = 
		"\xd1\x33\xf2\x2a\x1a\xed\x2a\x7b\xfa\x0f\x44\x69\x7c\x4f\x3f\xfd";
	static const uint8_t *isu1 = 
		"\x51\x66\x04\x95\x43\x53\x95\x03\x14\xfb\x86\xe4\x01\x92\x25\x21";
		
	static uint8_t *xkey;
	uint8_t block[16];
	int err;

	printf("Testing AES implementation:\n");
	
	printf("> Key expansion... ");
	expandkey((uint8_t *)xkeyinit, xkey);
	err = memcmp(xkey, xkeyinit, XKEY_SIZE);
	printf("%s\n", err? "failed" : "passed");

	printf("> AddRoundKey..... ");
	memcpy(block, text, 16);
	addroundkey(block, xkey, 0);
	err = memcmp(block, ark0, 16);
	printf("%s\n", err? "failed" : "passed");

	printf("> SubBytes........ ");
	subbytes(block);
	err = memcmp(block, sub1, 16);
	printf("%s\n", err? "failed" : "passed");

	printf("> ShiftRows....... ");
	shiftrows(block);
	err = memcmp(block, shr1, 16);
	printf("%s\n", err? "failed" : "passed");

	printf("> MixColumns...... ");
	mixcolumns(block);
	err = memcmp(block, mix1, 16);
	printf("%s\n", err? "failed" : "passed");

	printf("> Encryption...... ");
	memcpy(block, text, 16);
	encrypt_block(xkey, block);
	err = memcmp(block, cryp, 16);
	printf("%s\n", err? "failed" : "passed");

	printf("> iMixColumns..... ");
	memcpy(block, ista, 16);
	imixcolumns(block);
	err = memcmp(block, imi1, 16);
	printf("%s\n", err? "failed" : "passed");

	printf("> iShiftRows...... ");
	ishiftrows(block);
	err = memcmp(block, ish1, 16);
	printf("%s\n", err? "failed" : "passed");

	printf("> iSubBytes....... ");
	isubbytes(block);
	err = memcmp(block, isu1, 16);
	printf("%s\n", err? "failed" : "passed");

	printf("> Decryption...... ");
	memcpy(block, cryp, 16);
	decrypt_block(xkey, block);
	err = memcmp(block, text, 16);
	printf("%s\n", err? "failed" : "passed");
}

#define error(fmt, args...) do { \
	fprintf(stderr, fmt "\n", ##args); \
	err = 1; \
	goto out; \
} while (0)

int main(int argc, char **argv)
{
	int err = 0;
	char *infile = NULL;
	char *outfile = NULL;
	char *passwd = NULL;
	enum { NOACTION, ENCRYPT, DECRYPT } action = NOACTION;
	int opt;
	
	static uint8_t key[32];
	static uint8_t iv[16];
	static uint8_t xkey[XKEY_SIZE];
	FILE *instream = NULL;
	FILE *outstream = NULL;

	while ((opt = getopt(argc, argv, "edp:i:o:j:s")) >= 0) {
		switch (opt) {
			case 'e':
			case 'd':
				if (action != NOACTION)
					error("Make up your mind!");
				action = (opt == 'e')? ENCRYPT : DECRYPT;
				break;
			case 'p':
				passwd = optarg;
				break;
			case 'i':
				infile = optarg;
				break;
			case 'o':
				outfile = optarg;
				break;
			case 's':
				selftest();
				goto out;
			default:
				error("Usage: %s [-e|-d] -p passwd [-i infile] [-o outfile]", argv[0]);
		}
	}

	if (action == NOACTION) action = ENCRYPT;
	if (!passwd) error("Please provide a password.");

	instream = infile? fopen(infile, "r") : stdin;
	if (!instream)
		error("Can't open %s: %s.", infile? infile : "stdin", strerror(errno));
	
	outstream = outfile? fopen(outfile, "w+") : stdout;
	if (!outstream)
		error("Can't open %s: %s.", outfile? outfile : "stdout", strerror(errno));

	stretchkey(passwd, key, iv);
	expandkey(key, xkey);

	err = ((action == ENCRYPT)? encrypt_stream : decrypt_stream)(xkey, iv, instream, outstream);
	if (err) error("Error while %scrypting.\n", (action == ENCRYPT)? "en" : "de");

out:
	if (instream) fclose(instream);
	if (outstream) fclose(outstream);

	return err? EXIT_FAILURE : EXIT_SUCCESS;
}
